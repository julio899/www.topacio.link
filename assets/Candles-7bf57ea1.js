import{_ as We,u as Ae,r as M,I as te,k as Ne,A,f as ie,o as Oe,v as $e,J as Ee,l as He,a as J,g as K,d as le,t as N,m as se,e as Re,R as Pe,p as ze,b as qe,h as Ue}from"./index-36745a63.js";import{u as je,p as Je,C as Ke}from"./processDivergence-1cf10ade.js";const Ge=V=>(ze("data-v-e0939717"),V=V(),qe(),V),Qe=["id"],Xe={class:"legend"},Ye={key:0,class:"rsi"},Ze={key:0,class:"timer-counter"},ea=Ge(()=>le("span",null,"Left time",-1)),aa={__name:"Candles",props:{chartNameId:{type:String,required:!0},micro:{type:Boolean,required:!1},main:{type:Boolean,default:!0},spot:{type:Boolean,default:!1},t:{type:String,required:!1},price:{type:Object,required:!1},dataCandles:{type:Array,required:!1,default:()=>[]}},emits:["resizeChart","crosshairMove"],setup(V,{expose:re,emit:ne}){var ae;const t=je(),w=Ae(),f=new Ue,h=V,oe=ne;let d=[];const O=M(!1),v=M(0),$=M(!1);let l,g,S,E=!1;const y=M(!1),G=M(null),L=M(null);let H,R,P,Q,k,_,X,z,q,F,x,I;const b=te({bajista:[],alcista:[]}),D=te({alcistas:[],bajistas:[]});Ne(()=>{l&&l.remove()});const ce=()=>{const e=new Je(t.chart.data);return new Promise((s,r)=>{e.agregarCallback(a=>{b.alcista=a.alcista,b.bajista=a.bajista}),s(e.iniciarProceso())})},he=()=>{let e=f.calculateEMA(t.chart.data,200,"#F2F7A1");Q.setData(e)};function T(){const e=new Date().getTime()+G.value*1e3-Date.parse(new Date),s=Math.floor(e/1e3%60),r=Math.floor(e/1e3/60%60),a=Math.floor(e/(1e3*60*60)%24),c=Math.floor(e/(1e3*60*60*24));return{total:e,days:c<10?"0"+c:c,hours:a<10?"0"+a:a,minutes:r<10?"0"+r:r,seconds:s<10?"0"+s:s}}const ue=A(()=>T().seconds),fe=A(()=>T().minutes),de=A(()=>T().hours);A(()=>T().days);const pe=()=>{const e=t.chart.data.flatMap(s=>({time:s.time,value:s.volume,color:"#d1e1e159"}));f.analisisVolumen(e),S.setData(e)},Y=()=>{const e=document.querySelector(`#${h.chartNameId}`),s=parseInt(e.offsetWidth/1.01),r=parseInt(e.offsetHeight/1.01);let a=f.getConfigChart(s,r);const c=f.getConfigVelasTransparentes();l=Ke(e,a),g=l.addCandlestickSeries(c),S=l.addHistogramSeries({lastValueVisible:!1,priceLineVisible:!1,priceFormat:{type:"volume"},priceScaleId:"volumen"}),S.priceScale().applyOptions({priceFormat:{type:"volume"},scaleMargins:{top:.85,bottom:0}}),h.micro&&h.micro===!0&&h.t&&l.applyOptions({watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${h.t} Seg.`,fontSize:14,horzAlign:"left",vertAlign:"top"}}),H=l.addLineSeries({color:"#f6483e33",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),R=l.addLineSeries({color:"#f0f8ff8f",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:2}),P=l.addLineSeries({color:"#00ffa521",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),Q=l.addLineSeries({color:"yellow",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:3}),k=l.addLineSeries({color:"#84ff3d8a",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),_=l.addLineSeries({color:"orange",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),X=l.addLineSeries({color:"#f70776",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),z=l.addLineSeries({color:"#00bbf0",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),q=l.addLineSeries({color:"#bae8e8",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),l.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),F=l.addLineSeries({color:"yellow",lineWidth:4,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),x=l.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),I=l.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1})},Z=async e=>{if(t.chart.data.length!=0)return G.value=parseInt((e.time-new Date().getTime())/1e3),new Promise(async(s,r)=>{e==null&&(console.log("#",e),r("undefined lastCandle"));const a=h.micro===!0&&h.t,c=a?d:t.chart.data;let o=JSON.parse(JSON.stringify(c));if(!(o.length<=15)){if(o[o.length-1].close=e.close,o[o.length-1].high=e.high,o[o.length-1].low=e.low,!a){const i=o.flatMap(n=>n.close),u=await f.calculoRSI(i);y.value=parseFloat(u[u.length-1]).toFixed(2)}s(y.value)}})},ee=async(e=!0)=>{$.value=e;const s=t.chart.data.flatMap(u=>u.close),r=await f.calculoRSI(s);let a=f.calcularMACD(s);const c=await f.calculateBollingerBands(s,89,3),o=f.calculateHMA(t.chart.data,10).flatMap(u=>u.value),i=f.calculateHMA(t.chart.data,20).flatMap(u=>u.value);t.chart.data[t.chart.data.length-1].bb||console.log("** noposee BB ",t.chart.data[t.chart.data.length-1],{isMicro:h.micro}),t.chart.data[t.chart.data.length-1].bb=c.pop(),t.chart.data[t.chart.data.length-1].rsi=r.pop(),t.chart.data[t.chart.data.length-1].macd=a.pop(),t.chart.data[t.chart.data.length-1].hma10=o.pop(),t.chart.data[t.chart.data.length-1].hma20=i.pop(),y.value=t.chart.data[t.chart.data.length-1].rsi,console.log("* recalculate")},me=()=>{var e,s;if(H.setData([]),P.setData([]),R.setData([]),!(!t.chart.indicators.bb||t.chart.data.length==0)&&(s=(e=t.chart.data[t.chart.data.length-1])==null?void 0:e.bb)!=null&&s.upper){let o=function(p,m){return p.time<m.time?-1:p.time>m.time?1:0};const r=t.chart.data.flatMap(p=>{let m={value:p.bb.upper,time:p.time};return p.high>p.bb.upper&&(m.color="#f443369e"),m}),a=t.chart.data.flatMap(p=>{let m={value:p.bb.lower,time:p.time};return p.low<p.bb.lower&&(m.color="#00ffa58a"),m}),c=t.chart.data.flatMap(p=>({value:p.bb.middle,time:p.time})),i=r.sort(o),u=a.sort(o),n=c.sort(o);console.log("check order",{dt_orderHigh:i,dt_orderLow:u,dt_orderMiddle:n}),H.setData(i),P.setData(u),R.setData(n)}},ge=()=>{if(h.micro&&d.length>=20){const e=d.sort((a,c)=>a.time<c.time?-1:a.time>c.time?1:0);console.log("renderHmaMicro",{dataCandlesMicro:d,dtOrdernada:e});const s=f.calculateHMA(e,10);k.setData(s);const r=f.calculateHMA(e,20,"#f70776");_.setData(r)}},be=()=>{if(!h.micro){if(t.chart.data=t.chart.data.sort((e,s)=>e.time<s.time?-1:e.time>s.time?1:0),t.chart.indicators.hma10){const e=t.chart.data.flatMap(s=>({value:s.hma10,time:s.time}));k.setData(e)}if(t.chart.indicators.hma20){const e=t.chart.data.flatMap(s=>({value:s.hma20,time:s.time}));_.setData(e)}if(t.chart.indicators.hma55){const e=f.calculateHMA(t.chart.data,55,"#f70776");X.setData(e)}if(t.chart.indicators.hma89){const e=f.calculateHMA(t.chart.data,89,"#9896f1");z.setData(e)}if(t.chart.indicators.hma233){const e=f.calculateHMA(t.chart.data,233,"#00bbf0");q.setData(e)}}},Se=async e=>{w.loading=!0;const s=String(t.getSymbol).toLowerCase(),r=String(e.value).toLowerCase(),a=`${s}@kline_${t.getTemporality}`,c=`${r}@kline_${t.getTemporality}`;console.log("resetMicro",{evt:e}),b.alcista=[],b.bajista=[],D.bajistas=[],D.alcistas=[],d=[],F.setData([]),x.setData([]),I.setData([]),k.setData([]),_.setData([]),z.setData([]),q.setData([]),l.applyOptions({priceScale:{scaleMargins:{top:.1,bottom:.1}},watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${h.t} Seg.`,fontSize:14,horzAlign:"left",vertAlign:"top"}}),g.setData([]),await L.value.send(JSON.stringify({method:"UNSUBSCRIBE",params:[a],id:new Date().getTime()})),await L.value.send(JSON.stringify({method:"SUBSCRIBE",params:[c],id:new Date().getTime()})),w.loading=!1},ve=async e=>{l.remove(),b.alcista=[],b.bajista=[],D.bajistas=[],D.alcistas=[];const s=String(t.getSymbol).toLowerCase(),r=String(e.value).toLowerCase(),a=`${s}@kline_${t.getTemporality}`,c=`${r}@kline_${t.getTemporality}`;Y(),console.log("* changeTarget Candles",{evt:e,symbolsMinuscula:s,previusSocket:a}),L.value&&(L.value.send(JSON.stringify({method:"UNSUBSCRIBE",params:[a],id:new Date().getTime()})),L.value.send(JSON.stringify({method:"SUBSCRIBE",params:[c],id:new Date().getTime()})))},Le=async()=>{const e=String(t.getSymbol).toLowerCase(),s=t.getTemporality,{spot:r}=h;if(r===!1){L.value=await new WebSocket(`wss://fstream.binance.com/ws/${e}@kline_${s}`);let a,c=0;L.value.addEventListener("message",async function(o){var u;if(w.loading||t.chart.data.length===0)return;const i=JSON.parse(o.data);if(o&&(i!=null&&i.s)&&i.result==null&&(i!=null&&i.k)&&(i==null?void 0:i.k)!=null&&((u=i==null?void 0:i.k)==null?void 0:u.i)==t.getTemporality&&String(i.s).toUpperCase()==String(t.getSymbol).toUpperCase()){console.log(String(i.s).toUpperCase()==String(t.getSymbol).toUpperCase(),i.s,t.getSymbol);const n=parseFloat(i.k.c);i.k.T&&parseInt(i.k.T);const p=i.k.x?i.k.x:!1,m=i.k.V?parseFloat(i.k.V):null,{micro:C,t:B,spot:ta}=h;if(C||(a={time:parseInt(i.k.T),open:parseFloat(i.k.o),high:parseFloat(i.k.h),low:parseFloat(i.k.l),close:n,value:n,volume:m},a.close=n,a.value=n,a.volume=m,a.high&&n>a.high&&(a.high=n),a&&a.low&&n<a.low&&(a.low=n),h.micro&&h.t?a.time=parseInt(v.value):a.time=parseInt(i.k.T),a&&a.close&&Z(a)),!O.value&&C==!0&&B&&(v.value=i.E+B*1e3,a={time:v.value,open:parseFloat(n),high:parseFloat(n),low:parseFloat(n),close:n,value:n,volume:m},O.value=!0),p&&!C){const W=t.chart.data[t.chart.data.length-1].time-t.chart.data[t.chart.data.length-2].time;a.time=parseInt(i.k.T)+W,a.open=parseFloat(i.k.o),a.high=parseFloat(i.k.h),a.low=parseFloat(i.k.l),a.close=parseFloat(n),a.volume=m,t.chart.data.push(a),$.value=!0,De()}if(C&&B&&O.value&&(E&&(a.open=parseFloat(n),a.high=parseFloat(n),a.low=parseFloat(n),a.close=n,a.value=n,a.volume=m,E=!1),a.time=v.value,a.close=n,a.value=n,a.volume=m,C===!0&&d.length==0&&(a={time:parseInt(i.k.T),open:n,high:n,low:n,close:n,value:n,volume:m}),n>a.high&&(a.high=n),n<a.low&&(a.low=n),i.E>v.value&&($.value=!0,E=!0,v.value=i.E+B*1e3,a.time=parseInt(v.value),d.push(JSON.parse(JSON.stringify(a))),d=d.sort((U,j)=>j.time-U.time).filter((U,j,Te)=>j===Te.findIndex(Be=>Be.time===U.time)),d.length>1&&Ve()),a&&a.close&&d.length>1&&Z(a)),i.E>c&&a&&a.time&&l&&g)try{g.update(a)}catch(W){console.log({chart:l,candleSeries:g,e:W})}}c=i.E})}},Ve=async()=>{ge(),ye(),Me()},ye=()=>{if(d.length>=5){const s=d.sort((o,i)=>i.high-o.high),r=d.flatMap(o=>o.close),a=Pe.calculate({values:r,period:10}),c=d.slice(5*-1);console.log("calcularDivergenciaMicro",{dtOrdernadaPriceHigh:s,highLast30Candles:c,closeMicro:r,rsi:a})}},De=async()=>{h.micro||(await ee(),me(),be(),ke(),he())},Me=()=>{if(d.length<=5)return;const e=d.sort((i,u)=>i.time-u.time),s=e.length<89?e.length:80,r=f.kernelChannel(e,s,2.5),a=r.flatMap(i=>({time:i.time,value:parseFloat(parseFloat(i.upperChannel).toFixed(4))})),c=r.flatMap(i=>({time:i.time,value:parseFloat(parseFloat(i.lowerChannel).toFixed(4))})),o=r.flatMap(i=>({time:i.time,value:parseFloat(parseFloat(i.smoothedData).toFixed(4))}));F.setData(o),x.setData(a),I.setData(c),console.log({channelData:r,dtOrdernadaPriceHigh:e})},we=e=>{l&&g&&(g.setData(e),console.log("setDataChart",{data:e}))},Ce=e=>{l&&(l!=null&&l.resize)&&l.resize(e.width,e.height)},ke=()=>{const s=f.kernelChannel(t.chart.data,89,2.5),r=s.flatMap(o=>({time:o.time,value:parseFloat(parseFloat(o.upperChannel).toFixed(4))})),a=s.flatMap(o=>({time:o.time,value:parseFloat(parseFloat(o.lowerChannel).toFixed(4))})),c=s.flatMap((o,i)=>{const u=parseFloat(o.smoothedData)<t.chart.data[i].close?"#A6FF96":"#DA0C81";return{time:o.time,value:parseFloat(parseFloat(o.smoothedData).toFixed(4)),color:u}});F.setData(c),x.setData(r),I.setData(a)},_e=()=>{setTimeout(function(){new Promise((e,s)=>{b.bajista.length>0&&b.bajista.forEach(r=>{let a=l.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});a.setData(r),D.bajistas.push(a)}),b.alcista.length>0&&b.alcista.forEach(r=>{let a=l.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});a.setData(r),D.alcistas.push(a)}),e(!0)})},0)};(ae=t==null?void 0:t.getIndicators)!=null&&ae.divergences&&h.main&&h.main===!0&&setTimeout(function(){Promise.resolve(ce()).then(_e())},0),ie(()=>h.price,e=>{e!=null&&e.time&&(g.update(e),e!=null&&e.volume&&S&&(S!=null&&S.setData)&&S.update({time:e.time,value:e.volume,color:"#d1e1e159"}))}),ie(()=>t.chart.data,function(e){if(h.main&&h.main===!0){l.priceScale("right").applyOptions({autoScale:!0,scaleMargins:{top:.1,bottom:.1}}),g.setData([]),g.setData(t.chart.data);const s=new Date().toLocaleString();h.main&&h.main===!0&&l.applyOptions({watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${t.getTemporality}  ${s}`,fontSize:14,horzAlign:"left",vertAlign:"top"}}),pe()}});const Fe=(e,s)=>s.time&&s.seriesData.get(e)||null,xe=(e,s,r)=>{if(r){e.setCrosshairPosition(r,r.time,s);return}l.clearCrosshairPosition()},Ie=e=>{e.visibleLogicalRange=l&&l.timeScale?l.timeScale().getVisibleLogicalRange():null;const s=Fe(g,e);e.dataPoint=s,e.sync=xe(g,s),oe("crosshairMove",e)};return Oe(async()=>{await Y(),Le(),l&&(l!=null&&l.subscribeCrosshairMove)&&l.subscribeCrosshairMove(Ie)}),re({chartStore:t,mainStore:w,chartNameId:h.chartNameId,lastRSI:y,changeTarget:ve,resetMicro:Se,resizeChart:Ce,recalculate:ee,chart:l,setDataChart:we}),(e,s)=>$e((J(),K("div",{id:V.chartNameId,ref:"chartElement",class:"charts-graphy"},[le("div",Xe,[y.value?(J(),K("label",Ye,"RSI:"+N(y.value),1)):se("",!0)]),h.micro?se("",!0):(J(),K("div",Ze,[ea,Re(" "+N(de.value)+":"+N(fe.value)+":"+N(ue.value),1)]))],8,Qe)),[[Ee,!He(w).loading]])}},ra=We(aa,[["__scopeId","data-v-e0939717"]]);export{ra as C};
