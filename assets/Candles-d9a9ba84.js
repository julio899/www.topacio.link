import{_ as Ae,u as Oe,r as M,I as le,k as Ne,A,f as J,o as $e,v as Ee,J as He,l as Re,a as K,g as G,d as ne,t as O,m as re,e as Pe,R as ze,p as qe,b as je,h as Ue}from"./index-b1873696.js";import{u as Je,p as Ke,C as Ge}from"./processDivergence-4d829698.js";const Qe=V=>(qe("data-v-433b20c2"),V=V(),je(),V),Xe=["id"],Ye={class:"legend"},Ze={key:0,class:"rsi"},ea={key:0,class:"timer-counter"},aa=Qe(()=>ne("span",null,"Left time",-1)),ta={__name:"Candles",props:{chartNameId:{type:String,required:!0},micro:{type:Boolean,required:!1},main:{type:Boolean,default:!0},spot:{type:Boolean,default:!1},t:{type:String,required:!1},price:{type:Object,required:!1},dataCandles:{type:Array,required:!1,default:()=>[]},chartIndicators:{type:Object,required:!1,default:()=>{}}},emits:["resizeChart","crosshairMove"],setup(V,{expose:oe,emit:ce}){var se;const t=Je(),C=Oe(),f=new Ue,c=V,he=ce;let u=[];const N=M(!1),v=M(0),$=M(!1);let r,g,S,E=!1;const y=M(!1),Q=M(null),L=M(null);let H,R,P,X,w,_,Y,z,q,F,I,x;const b=le({bajista:[],alcista:[]}),D=le({alcistas:[],bajistas:[]});Ne(()=>{r&&r.remove()});const de=()=>{const e=new Ke(t.chart.data);return new Promise((i,l)=>{e.agregarCallback(a=>{b.alcista=a.alcista,b.bajista=a.bajista}),i(e.iniciarProceso())})},fe=()=>{let e=f.calculateEMA(t.chart.data,200,"#F2F7A1");X.setData(e)};function T(){const e=new Date().getTime()+Q.value*1e3-Date.parse(new Date),i=Math.floor(e/1e3%60),l=Math.floor(e/1e3/60%60),a=Math.floor(e/(1e3*60*60)%24),h=Math.floor(e/(1e3*60*60*24));return{total:e,days:h<10?"0"+h:h,hours:a<10?"0"+a:a,minutes:l<10?"0"+l:l,seconds:i<10?"0"+i:i}}const ue=A(()=>T().seconds),pe=A(()=>T().minutes),me=A(()=>T().hours);A(()=>T().days);const ge=()=>{const e=t.chart.data.flatMap(i=>({time:i.time,value:i.volume,color:"#d1e1e159"}));f.analisisVolumen(e),S.setData(e)},Z=()=>{const e=document.querySelector(`#${c.chartNameId}`),i=parseInt(e.offsetWidth/1.01),l=parseInt(e.offsetHeight/1.01);let a=f.getConfigChart(i,l);const h=f.getConfigVelasTransparentes();r=Ge(e,a),g=r.addCandlestickSeries(h),S=r.addHistogramSeries({lastValueVisible:!1,priceLineVisible:!1,priceFormat:{type:"volume"},priceScaleId:"volumen"}),S.priceScale().applyOptions({priceFormat:{type:"volume"},scaleMargins:{top:.85,bottom:0}}),H=r.addLineSeries({color:"#f6483e33",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),R=r.addLineSeries({color:"#f0f8ff8f",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:2}),P=r.addLineSeries({color:"#00ffa521",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),X=r.addLineSeries({color:"yellow",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:3}),w=r.addLineSeries({color:"#84ff3d8a",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),_=r.addLineSeries({color:"orange",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),Y=r.addLineSeries({color:"#f70776",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),z=r.addLineSeries({color:"#00bbf0",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),q=r.addLineSeries({color:"#bae8e8",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),r.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),F=r.addLineSeries({color:"yellow",lineWidth:4,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),I=r.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),x=r.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),c.micro&&c.micro===!0&&c.t&&r.applyOptions({watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${c.t} Seg.`,fontSize:14,horzAlign:"left",vertAlign:"top"}})},ee=async e=>{if(t.chart.data.length!=0)return Q.value=parseInt((e.time-new Date().getTime())/1e3),new Promise(async(i,l)=>{e==null&&(console.log("#",e),l("undefined lastCandle"));const a=c.micro===!0&&c.t,h=a?u:t.chart.data;let o=JSON.parse(JSON.stringify(h));if(!(o.length<=15)){if(o[o.length-1].close=e.close,o[o.length-1].high=e.high,o[o.length-1].low=e.low,!a){const s=o.flatMap(n=>n.close),d=await f.calculoRSI(s);y.value=parseFloat(d[d.length-1]).toFixed(2)}i(y.value)}})},ae=async(e=!0)=>{$.value=e;const i=t.chart.data.flatMap(d=>d.close),l=await f.calculoRSI(i);let a=f.calcularMACD(i);const h=await f.calculateBollingerBands(i,89,3),o=f.calculateHMA(t.chart.data,10).flatMap(d=>d.value),s=f.calculateHMA(t.chart.data,20).flatMap(d=>d.value);t.chart.data[t.chart.data.length-1].bb||console.log("** noposee BB ",t.chart.data[t.chart.data.length-1],{isMicro:c.micro}),t.chart.data[t.chart.data.length-1].bb=h.pop(),t.chart.data[t.chart.data.length-1].rsi=l.pop(),t.chart.data[t.chart.data.length-1].macd=a.pop(),t.chart.data[t.chart.data.length-1].hma10=o.pop(),t.chart.data[t.chart.data.length-1].hma20=s.pop(),y.value=t.chart.data[t.chart.data.length-1].rsi,console.log("* recalculate")},be=()=>{var e,i;if(H.setData([]),P.setData([]),R.setData([]),!(!t.chart.indicators.bb||t.chart.data.length==0)&&(i=(e=t.chart.data[t.chart.data.length-1])==null?void 0:e.bb)!=null&&i.upper){let o=function(p,m){return p.time<m.time?-1:p.time>m.time?1:0};const l=t.chart.data.flatMap(p=>{let m={value:p.bb.upper,time:p.time};return p.high>p.bb.upper&&(m.color="#f443369e"),m}),a=t.chart.data.flatMap(p=>{let m={value:p.bb.lower,time:p.time};return p.low<p.bb.lower&&(m.color="#00ffa58a"),m}),h=t.chart.data.flatMap(p=>({value:p.bb.middle,time:p.time})),s=l.sort(o),d=a.sort(o),n=h.sort(o);console.log("check order",{dt_orderHigh:s,dt_orderLow:d,dt_orderMiddle:n}),H.setData(s),P.setData(d),R.setData(n)}},Se=()=>{if(c.micro&&u.length>=20){const e=u.sort((a,h)=>a.time<h.time?-1:a.time>h.time?1:0);console.log("renderHmaMicro",{dataCandlesMicro:u,dtOrdernada:e});const i=f.calculateHMA(e,10);w.setData(i);const l=f.calculateHMA(e,20,"#f70776");_.setData(l)}},ve=()=>{if(!c.micro){if(t.chart.data=t.chart.data.sort((e,i)=>e.time<i.time?-1:e.time>i.time?1:0),t.chart.indicators.hma10){const e=t.chart.data.flatMap(i=>({value:i.hma10,time:i.time}));w.setData(e)}if(t.chart.indicators.hma20){const e=t.chart.data.flatMap(i=>({value:i.hma20,time:i.time}));_.setData(e)}if(t.chart.indicators.hma55){const e=f.calculateHMA(t.chart.data,55,"#f70776");Y.setData(e)}if(t.chart.indicators.hma89){const e=f.calculateHMA(t.chart.data,89,"#9896f1");z.setData(e)}if(t.chart.indicators.hma233){const e=f.calculateHMA(t.chart.data,233,"#00bbf0");q.setData(e)}}},Le=async e=>{C.loading=!0;const i=String(t.getSymbol).toLowerCase(),l=String(e.value).toLowerCase(),a=`${i}@kline_${t.getTemporality}`,h=`${l}@kline_${t.getTemporality}`;console.log("resetMicro",{evt:e}),b.alcista=[],b.bajista=[],D.bajistas=[],D.alcistas=[],u=[],F.setData([]),I.setData([]),x.setData([]),w.setData([]),_.setData([]),z.setData([]),q.setData([]),r.applyOptions({priceScale:{scaleMargins:{top:.1,bottom:.1}},watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${c.t} Seg.`,fontSize:14,horzAlign:"left",vertAlign:"top"}}),g.setData([]),await L.value.send(JSON.stringify({method:"UNSUBSCRIBE",params:[a],id:new Date().getTime()})),await L.value.send(JSON.stringify({method:"SUBSCRIBE",params:[h],id:new Date().getTime()})),C.loading=!1},Ve=async e=>{r.remove(),b.alcista=[],b.bajista=[],D.bajistas=[],D.alcistas=[];const i=String(t.getSymbol).toLowerCase(),l=String(e.value).toLowerCase(),a=`${i}@kline_${t.getTemporality}`,h=`${l}@kline_${t.getTemporality}`;Z(),c.micro&&te([]),console.log("* changeTarget Candles",{evt:e,symbolsMinuscula:i,previusSocket:a}),L.value&&(L.value.send(JSON.stringify({method:"UNSUBSCRIBE",params:[a],id:new Date().getTime()})),L.value.send(JSON.stringify({method:"SUBSCRIBE",params:[h],id:new Date().getTime()})))},ye=async()=>{const e=String(t.getSymbol).toLowerCase(),i=t.getTemporality,{spot:l}=c;if(l===!1){L.value=await new WebSocket(`wss://fstream.binance.com/ws/${e}@kline_${i}`);let a,h=0;L.value.addEventListener("message",async function(o){var d;if(C.loading||t.chart.data.length===0)return;const s=JSON.parse(o.data);if(o&&(s!=null&&s.s)&&s.result==null&&(s!=null&&s.k)&&(s==null?void 0:s.k)!=null&&((d=s==null?void 0:s.k)==null?void 0:d.i)==t.getTemporality&&String(s.s).toUpperCase()==String(t.getSymbol).toUpperCase()){const n=parseFloat(s.k.c);s.k.T&&parseInt(s.k.T);const p=s.k.x?s.k.x:!1,m=s.k.V?parseFloat(s.k.V):null,{micro:k,t:B,spot:ia}=c;if(k||(a={time:parseInt(s.k.T),open:parseFloat(s.k.o),high:parseFloat(s.k.h),low:parseFloat(s.k.l),close:n,value:n,volume:m},a.close=n,a.value=n,a.volume=m,a.high&&n>a.high&&(a.high=n),a&&a.low&&n<a.low&&(a.low=n),c.micro&&c.t?a.time=parseInt(v.value):a.time=parseInt(s.k.T),a&&a.close&&ee(a)),!N.value&&k==!0&&B&&(v.value=s.E+B*1e3,a={time:v.value,open:parseFloat(n),high:parseFloat(n),low:parseFloat(n),close:n,value:n,volume:m},N.value=!0),p&&!k){const W=t.chart.data[t.chart.data.length-1].time-t.chart.data[t.chart.data.length-2].time;a.time=parseInt(s.k.T)+W,a.open=parseFloat(s.k.o),a.high=parseFloat(s.k.h),a.low=parseFloat(s.k.l),a.close=parseFloat(n),a.volume=m,t.chart.data.push(a),$.value=!0,Ce()}if(k&&B&&N.value&&(E&&(a.open=parseFloat(n),a.high=parseFloat(n),a.low=parseFloat(n),a.close=n,a.value=n,a.volume=m,E=!1),a.time=v.value,a.close=n,a.value=n,a.volume=m,k===!0&&u.length==0&&(a={time:parseInt(s.k.T),open:n,high:n,low:n,close:n,value:n,volume:m}),n>a.high&&(a.high=n),n<a.low&&(a.low=n),s.E>v.value&&($.value=!0,E=!0,v.value=s.E+B*1e3,a.time=parseInt(v.value),u.push(JSON.parse(JSON.stringify(a))),u=u.sort((j,U)=>U.time-j.time).filter((j,U,Be)=>U===Be.findIndex(We=>We.time===j.time)),u.length>1&&De()),a&&a.close&&u.length>1&&ee(a)),s.E>h&&a&&a.time&&r&&g)try{g.update(a)}catch(W){console.log({chart:r,candleSeries:g,e:W})}}h=s.E})}},De=async()=>{Se(),Me(),ke()},Me=()=>{if(u.length>=5){const i=u.sort((o,s)=>s.high-o.high),l=u.flatMap(o=>o.close),a=ze.calculate({values:l,period:10}),h=u.slice(5*-1);console.log("calcularDivergenciaMicro",{dtOrdernadaPriceHigh:i,highLast30Candles:h,closeMicro:l,rsi:a})}},Ce=async()=>{c.micro||(await ae(),be(),ve(),_e(),fe())},ke=()=>{if(u.length<=5)return;const e=u.sort((s,d)=>s.time-d.time),i=e.length<89?e.length:80,l=f.kernelChannel(e,i,2.5),a=l.flatMap(s=>({time:s.time,value:parseFloat(parseFloat(s.upperChannel).toFixed(4))})),h=l.flatMap(s=>({time:s.time,value:parseFloat(parseFloat(s.lowerChannel).toFixed(4))})),o=l.flatMap(s=>({time:s.time,value:parseFloat(parseFloat(s.smoothedData).toFixed(4))}));F.setData(o),I.setData(a),x.setData(h),console.log({channelData:l,dtOrdernadaPriceHigh:e})},te=e=>{r&&g&&(g.setData(e),console.log("setDataChart",{data:e}))},we=e=>{r&&(r!=null&&r.resize)&&r.resize(e.width,e.height)},_e=()=>{const i=f.kernelChannel(t.chart.data,89,2.5),l=i.flatMap(o=>({time:o.time,value:parseFloat(parseFloat(o.upperChannel).toFixed(4))})),a=i.flatMap(o=>({time:o.time,value:parseFloat(parseFloat(o.lowerChannel).toFixed(4))})),h=i.flatMap((o,s)=>{const d=parseFloat(o.smoothedData)<t.chart.data[s].close?"#A6FF96":"#DA0C81";return{time:o.time,value:parseFloat(parseFloat(o.smoothedData).toFixed(4)),color:d}});F.setData(h),I.setData(l),x.setData(a)},Fe=()=>{setTimeout(function(){new Promise((e,i)=>{b.bajista.length>0&&b.bajista.forEach(l=>{let a=r.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});a.setData(l),D.bajistas.push(a)}),b.alcista.length>0&&b.alcista.forEach(l=>{let a=r.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});a.setData(l),D.alcistas.push(a)}),e(!0)})},0)};(se=t==null?void 0:t.getIndicators)!=null&&se.divergences&&c.main&&c.main===!0&&setTimeout(function(){Promise.resolve(de()).then(Fe())},0),J(()=>c.price,e=>{e!=null&&e.time&&(g.update(e),e!=null&&e.volume&&S&&(S!=null&&S.setData)&&S.update({time:e.time,value:e.volume,color:"#d1e1e159"}))});const ie=e=>{if(e)g.setData(t.chart.data);else{const i=t.chart.data.flatMap(l=>(delete l.color,delete l.borderColor,delete l.wickColor,l));g.setData(i)}};J(()=>c.chartIndicators.cci,e=>{ie(e)}),J(()=>t.chart.data,function(e){if(ie(c.chartIndicators.cci),c.main&&c.main===!0){r.priceScale("right").applyOptions({autoScale:!0,scaleMargins:{top:.1,bottom:.1}});const i=new Date().toLocaleString();c.main&&c.main===!0&&r.applyOptions({watermark:{color:"#00ff11",visible:!0,text:`Topacio ${String(t.getSymbol).toUpperCase()}  ${t.getTemporality}  ${i}`,fontSize:14,horzAlign:"left",vertAlign:"top"}}),ge()}});const Ie=(e,i)=>i.time&&i.seriesData.get(e)||null,xe=(e,i,l)=>{if(l){e.setCrosshairPosition(l,l.time,i);return}},Te=e=>{e.visibleLogicalRange=r&&r.timeScale?r.timeScale().getVisibleLogicalRange():null;const i=Ie(g,e);e.dataPoint=i,e.sync=xe(g,i),he("crosshairMove",e)};return $e(async()=>{await Z(),ye(),r&&(r!=null&&r.subscribeCrosshairMove)&&r.subscribeCrosshairMove(Te)}),oe({chartStore:t,mainStore:C,chartNameId:c.chartNameId,lastRSI:y,changeTarget:Ve,resetMicro:Le,resizeChart:we,recalculate:ae,chart:r,setDataChart:te}),(e,i)=>Ee((K(),G("div",{id:V.chartNameId,ref:"chartElement",class:"charts-graphy"},[ne("div",Ye,[y.value?(K(),G("label",Ze,"RSI:"+O(y.value),1)):re("",!0)]),c.micro?re("",!0):(K(),G("div",ea,[aa,Pe(" "+O(me.value)+":"+O(pe.value)+":"+O(ue.value),1)]))],8,Xe)),[[He,!Re(C).loading]])}},na=Ae(ta,[["__scopeId","data-v-433b20c2"]]);export{na as C};
