import{_ as Se}from"./Selector-wpoeiO5J.js";import{V as Le}from"./lightweight-charts.production-Cq3om6Hu.js";import{u as De}from"./chart-Cs93wLR8.js";import{_ as ye,u as ke,r as d,o as Me,c7 as we,p as _e,h as te,b as le,d as p,e as Ce,t as x,q as M,f as Fe,k as $,i as We,cc as xe,a as se}from"./index-CrKpYukb.js";import{_ as ie,d as re}from"./ActivadorIndicator-BHhcSunG.js";const Be={class:"container-template-chart"},je={key:0,class:"price"},Te={class:"target-symbols"},Ne={class:"target-temporality"},Pe={__name:"Chart",setup(Ee,{expose:ne}){const q=ke(),f=new We;let w=null,n=null,g=null,v,V,S,L,D,y,B,j,T,N,P;const u={bajista:[],alcista:[]},h={bajistas:[],alcistas:[]},e=De(),m=d(null),_=d(null),E=d(null),I=d([]),K=d(null),b=d(0),C=d(!1),O=xe();d(null),d(null);const oe=re(()=>new Promise((a,l)=>{u.bajista.length>0&&u.bajista.forEach(s=>{let t=n.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});t.setData(s),h.bajistas.push(t)}),u.alcista.length>0&&u.alcista.forEach(s=>{let t=n.addLineSeries({color:"#fff",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,crosshairMarkerVisible:!1,lineStyle:0});t.setData(s),h.alcistas.push(t)}),a(!0)}),500),z=a=>{a.setData([])},A=()=>new Promise((a,l)=>{u.alcista.length>0&&h.alcistas.forEach(z),u.bajista.length>0&&h.bajistas.forEach(z),u.alcista=[],u.bajista=[],console.log("resetDivergences: indicators.divergences",e.chart.indicators.divergences),a(!0)}),ce=async()=>{const a=_.value.offsetHeight,l=_.value.offsetWidth,s=f.getConfigChart(l,a),t=f.getConfigVelasTransparentes();n=Le(_.value,s),w=n.addCandlestickSeries(t),L=n.addLineSeries({color:"#f6483e33",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),D=n.addLineSeries({color:"#f0f8ff8f",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:2}),y=n.addLineSeries({color:"#00ffa521",lineWidth:7,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),B=n.addLineSeries({color:"#84ff3d8a",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),j=n.addLineSeries({color:"orange",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),T=n.addLineSeries({color:"#f70776",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),N=n.addLineSeries({color:"#00bbf0",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),P=n.addLineSeries({color:"#bae8e8",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:0}),v=n.addLineSeries({color:"yellow",lineWidth:4,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),V=n.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),S=n.addLineSeries({color:"#c1c1c1",lineWidth:1,axisLabelVisible:!1,priceLineVisible:!1,lastValueVisible:!1,priceLineWidth:!1,crosshairMarkerVisible:!1,lineStyle:1}),E.value=n.addHistogramSeries({lastValueVisible:!1,priceLineVisible:!1,priceFormat:{type:"volume"},priceScaleId:"volumen"}),E.value.priceScale().applyOptions({priceFormat:{type:"volume"},scaleMargins:{top:.85,bottom:0}});const i=(await e.searchSymbolsFutures()).flatMap(r=>e.chart.symbols!=r.symbol?{label:r.symbol,value:r.symbol}:{label:r.symbol,value:r.symbol,selected:!0});I.value=i.filter(r=>r.value.includes("USDT"));const k=String(e.getSymbol).toLowerCase();g=await new WebSocket(`wss://fstream.binance.com/ws/${k}@kline_${e.getTemporality}`),g.addEventListener("open",r=>{console.log("* open",{event:r})}),g.addEventListener("message",async function(r){var W;if(r!=null&&r.data){const o=JSON.parse(r.data);if(!o||!((W=o==null?void 0:o.k)!=null&&W.c))return;const R=parseFloat(o.k.c);o.k.T&&parseInt(o.k.T),o.k.x&&o.k.x;const ve=o.k.V?parseFloat(o.k.V):null;if(o.s==e.getSymbol&&e.getTemporality==o.k.i){const Ve={time:parseInt(o.k.T),open:parseFloat(o.k.o),high:parseFloat(o.k.h),low:parseFloat(o.k.l),close:R,value:R,volume:ve};w.update(Ve),b.value=R}}}),n.timeScale().subscribeVisibleLogicalRangeChange(({from:r})=>{if(r&&r<100&&!C.value){console.log("*a buscar",C.value),C.value=!0;let W=e.chart.data[0].time;m.value.postMessage({command:"searchDataPrevius",data:{exchange:e.getExchange,interval:e.getTemporality,symbolsPairs:e.getSymbol,limit:500,cci:e.chart.indicators.cci,endTime:W}})}}),Q()},F=()=>{if(L.setData([]),y.setData([]),D.setData([]),!e.chart.indicators.bb)return;const a=e.chart.data.flatMap(t=>{let c={value:t.bb.upper,time:t.time};return t.high>t.bb.upper&&(c.color="#f443369e"),c}),l=e.chart.data.flatMap(t=>{let c={value:t.bb.lower,time:t.time};return t.low<t.bb.lower&&(c.color="#00ffa58a"),c}),s=e.chart.data.flatMap(t=>({value:t.bb.middle,time:t.time}));a.sort((t,c)=>t.time-c.time),l.sort((t,c)=>t.time-c.time),s.sort((t,c)=>t.time-c.time),L.setData(a),y.setData(l),D.setData(s)},ue=()=>{v.setData([]),V.setData([]),S.setData([]),A(),F(),h.bajistas=[],h.alcistas=[],console.log("***",{leneasRenderDivergences:h}),G()};Me(()=>{m.value=new Worker(new URL("/assets/chartWorker-BN8mUkBi.js",import.meta.url),{type:"module"}),ce(),m.value.onmessage=({data:{response:a,data:l}})=>{if(a==="searchData"&&(e.chart.data=l,w.setData(l),ue(),e.chart.indicators.divergences&&m.value.postMessage({command:"processDivergence",data:JSON.parse(JSON.stringify(e.chart.data))})),a==="responseProcessDivergence"&&l&&(console.log({response:a,data:l}),l.bajista?u.bajista=l.bajista:u.bajista=[],l.alcista?u.alcista=l.alcista:u.alcista=[],oe()),a==="searchDataPrevius"){const s=[].concat(l.toSpliced(-1),e.chart.data);return e.chart.data=s,w.setData(s),new Promise((t,c)=>{F(),G(),e.chart.indicators.divergences&&m.value.postMessage({command:"processDivergence",data:JSON.parse(JSON.stringify(e.chart.data))}),e.chart.indicators.kernelChannel?Z():(v.setData([]),V.setData([]),S.setData([])),ae(),C.value=!1,t(!0)})}},K.value=setInterval(he,1e3)}),we(()=>{m.value.terminate(),clearInterval(K.value)});const de=()=>{const l=`${String(e.getSymbol).toLowerCase()}@kline_${e.getTemporality}`;g.send(JSON.stringify({method:"UNSUBSCRIBE",params:[l],id:new Date().getTime()}))},me=()=>{Q(),g.send(JSON.stringify({method:"SUBSCRIBE",params:[`${String(e.getSymbol).toLowerCase()}@kline_${e.getTemporality}`],id:1}))},U=async a=>{ee(),await de(),q.loading=!0,b.value=null,console.log(e.getSymbol,"*",e.getTemporality),e.setSymbol(a.value),await me(),q.loading=!1},fe=a=>{const l=a.map(i=>i.value),s=l.reduce((i,k)=>i+k,0)/l.length;l.forEach(i=>{});const t=parseInt(s*2.5);return a.flatMap(i=>(i.value>=t&&(i.color="#96EFFF"),i))},he=()=>{new Date().toLocaleString()},G=()=>{const a=e.chart.data.flatMap(s=>({time:s.time,value:s.volume,color:"#d1e1e159"})),l=fe(a);E.value.setData(l)},Q=()=>{m.value.postMessage({command:"searchData",data:{exchange:e.getExchange,interval:e.getTemporality,symbolsPairs:e.getSymbol,limit:500,cci:e.chart.indicators.cci}})},J=_e(()=>b.value?b.value>.01?parseFloat(b.value).toFixed(4):parseFloat(b.value).toFixed(6):""),be=O.params&&O.params.temporality?O.params.temporality.toString().toLocaleLowerCase():"4h",pe=[{value:"1m",label:"1m"},{value:"5m",label:"5m"},{value:"15m",label:"15m"},{value:"30m",label:"30m"},{value:"1h",label:"1h"},{value:"2h",label:"2h"},{value:"4h",label:"4h"},{value:"1d",label:"1d"},{value:"3d",label:"3d"},{value:"1w",label:"1w"}],X=async a=>{e.chart.temporality=a.value,U({value:String(e.getSymbol)})},Y=d(pe.flatMap(a=>be==a.label?{value:a.value,label:a.label,selected:!0}:{value:a.value,label:a.label})),H=d("15m"),Z=()=>{const l=f.kernelChannel(e.chart.data,89,3.5),s=l.flatMap(i=>({time:i.time,value:parseFloat(parseFloat(i.upperChannel).toFixed(4))})),t=l.flatMap(i=>({time:i.time,value:parseFloat(parseFloat(i.lowerChannel).toFixed(4))})),c=l.flatMap((i,k)=>{const r=parseFloat(i.smoothedData)<e.chart.data[k].close?"#A6FF96":"#DA0C81";return{time:i.time,value:parseFloat(parseFloat(i.smoothedData).toFixed(4)),color:r}});v.setData(c),V.setData(s),S.setData(t)},ge=re(()=>{new Promise((a,l)=>(e.getcustomOption&&(m.value.postMessage({command:"processDivergence",data:JSON.parse(JSON.stringify(e.chart.data))}),e.chart.indicators.kernelChannel&&Z(),e.chart.indicators.bb&&F()),a(!0))),console.log("checkCustomIndicators")},500);te(e.getcustomOption,a=>{a?ge():(v.setData([]),V.setData([]),S.setData([]),L.setData([]),y.setData([]),D.setData([]),A(),console.log(e.getcustomOption,"clear")),console.log("*cambio",{status:a})});const ee=()=>{A(),B.setData([]),j.setData([]),T.setData([]),N.setData([]),P.setData([]),L.setData([]),y.setData([]),D.setData([])},ae=()=>{if(ee(),e.chart.indicators.divergences&&m.value.postMessage({command:"processDivergence",data:JSON.parse(JSON.stringify(e.chart.data))}),e.chart.indicators.bb&&F(),e.chart.indicators.hma10){const a=f.calculateHMA(e.chart.data,10);B.setData(a)}if(e.chart.indicators.hma20){const a=f.calculateHMA(e.chart.data,20,"#FF9D23");j.setData(a)}if(e.chart.indicators.hma55){const a=f.calculateHMA(e.chart.data,55,"#ff5733");T.setData(a)}if(e.chart.indicators.hma89){const a=f.calculateHMA(e.chart.data,89,"#9896f1");N.setData(a)}if(e.chart.indicators.hma233){const a=f.calculateHMA(e.chart.data,233,"#00bbf0");P.setData(a)}};return te(e.chart.indicators,a=>{ae()}),ne({chartStore:e,dataPairs:I,lastPrice:b,formatPrice:J,temporalityData:Y,targetTemporality:H,ActivadorIndicator:ie,changeTemporality:X,changeTarget:U}),(a,l)=>{const s=Se;return se(),le("div",Be,[p("h1",null,[Ce(x(M(e).getSymbol)+" "+x(M(e).getTemporality)+" ",1),J.value?(se(),le("span",je,"price: "+x(J.value),1)):Fe("",!0)]),p("article",null,[p("div",Te,[$(s,{opciones:I.value,onlyLabel:!1,lblPorDefecto:M(e).chart.symbols,onActionChange:U},null,8,["opciones","lblPorDefecto"])]),p("div",Ne,[$(s,{lblPorDefecto:M(e).getTemporality,opciones:Y.value,onlyLabel:!1,modelValue:H.value,"onUpdate:modelValue":l[0]||(l[0]=t=>H.value=t),onActionChange:X},null,8,["lblPorDefecto","opciones","modelValue"])]),p("pre",null,"        "+x(M(e).chart.indicators)+`
      `,1)]),p("section",{id:"chart-principal",ref_key:"chartElement",ref:_},[$(ie)],512)])}}},He=ye(Pe,[["__scopeId","data-v-561743a2"]]);export{He as default};
